<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Django administration</title>
    <style>
      :root {
        --secondary: #417690;
        --header-bg: var(--secondary);
        --accent: #f5dd5d;
        --primary: #264b5d;
        --breadcrumbs-bg: var(--primary);
        --primary-fg: #f7f7f7;
        --selected-row: #00363a;
        --body-bg: #121212;
        --darkened-bg: #212121;
        --hairline-color: #404040;
        --link-fg: #81d4fa;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        text-decoration: none;
        list-style: none;
        font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto,
          Helvetica, Arial, sans-serif;
        line-height: 1.4;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
      }

      /* Сброс браузерных стилей кнопок */
      button {
        background: none;
        border: none;
        padding: 0;
        color: inherit;
        font: inherit;
        line-height: inherit;
        text-align: inherit;
        outline: none;
        cursor: pointer;
      }

      /* Вернём видимость чекбоксов после глобального appearance: none */
      input[type="checkbox"] {
        -webkit-appearance: checkbox;
        -moz-appearance: checkbox;
        appearance: checkbox;
      }

      html,
      body {
        max-height: 100vh;
        overflow: auto;
      }

      .page {
        color: #ffffff;
        background: var(--body-bg);
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
      }
      /* ===== Header ===== */
      .header {
        background: var(--header-bg);
        padding: 10px 40px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .header__title {
        font-size: 1.5rem;
        font-weight: 300;
        color: var(--accent);
      }
      .header__user {
        font-size: 1.5rem;
        font-weight: 300;
        color: var(--accent);
      }

      /* ===== Breadcrumbs ===== */
      .breadcrumbs {
        background: var(--breadcrumbs-bg);
        padding: 10px 40px;
        color: #ffffff;
        font-size: 0.875rem;
      }
      .breadcrumbs__link {
        color: #4a90e2;
        text-decoration: none;
      }

      /* ===== Layout ===== */
      .layout {
        display: grid;
        grid-template-columns: 280px 1fr;
        grid-template-rows: 1fr;
        overflow: auto;
      }

      .layout__sidebar {
        background: var(--body-bg);
        padding: 16px 0;
        overflow: auto;
      }

      .layout__main {
        background: var(--body-bg);
        padding: 20px;
        overflow: auto;
      }

      /* ===== Sidebar ===== */
      .sidebar__search {
        padding: 0 16px 16px;
      }
      .sidebar__input {
        width: 100%;
        padding: 8px 12px;
        background: #202020;
        border: 1px solid #404040;
        border-radius: 4px;
        color: #ffffff;
        font-size: 14px;
        box-sizing: border-box;
      }
      .sidebar__input::placeholder {
        color: #9ca3af;
      }

      .sidebar__section {
        margin-bottom: 24px;
      }
      .sidebar__section-title {
        background: var(--header-bg);
        color: var(--primary-fg);
        font-size: 12px;
        font-weight: 400;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 8px;
        margin: 0;
      }
      .sidebar__list {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      .sidebar__item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 16px;
        color: #ffffff;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid var(--hairline-color);
      }
      .sidebar__item a:first-child {
        color: var(--link-fg);
        font-weight: 500;
        text-align: left;
      }
      .sidebar__item--active {
        background: var(--selected-row);
      }
      .sidebar__item:nth-child(even) {
        background: var(--darkened-bg);
      }
      .sidebar__add {
        color: #4a90e2;
        text-decoration: none;
        font-size: 0.8125rem;
        line-height: 1rem;
      }
      .sidebar__add::before {
        content: "+";
        color: #00ff00;
        margin-right: 4px;
      }

      /* ===== Main Content ===== */
      .main__title {
        font-size: 20px;
        font-weight: 600;
        color: #ffffff;
        margin: 0 0 20px;
      }

      .main__search {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
      }
      .main__search-group {
        flex: 1;
        display: flex;
        gap: 8px;
      }
      .main__search-input {
        flex: 1;
        padding: 8px 12px;
        background: #2a2a2a;
        border: 1px solid #404040;
        border-radius: 4px;
        color: #ffffff;
        font-size: 14px;
      }
      .main__search-btn {
        padding: 8px 16px;
        background: #4a90e2;
        border: none;
        border-radius: 4px;
        color: #ffffff;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        outline: 2px solid transparent;
      }
      .main__search-btn:hover {
        background: #357abd;
      }
      .main__search-btn:focus,
      .main__search-btn:active {
        outline: 2px solid white;
        outline-offset: 2px;
      }

      .main__filters {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }
      .main__filter {
        color: #ffffff;
        text-decoration: none;
        font-size: 14px;
        padding: 4px 8px;
        border-radius: 4px;
      }
      .main__filter--active {
        background: #4a90e2;
      }

      .crumb {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .arrow {
        color: white;
        margin-right: 6px;
      }

      .main__actions {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
        padding: 12px;
        background: #2a2a2a;
        border-radius: 4px;
      }
      .main__action-label {
        color: #ffffff;
        font-size: 14px;
      }
      .main__action-select {
        background: #202020;
        border: 1px solid #404040;
        border-radius: 4px;
        color: #ffffff;
        padding: 4px 8px;
        font-size: 14px;
      }
      .main__action-btn {
        padding: 4px 12px;
        background: #4a90e2;
        border: none;
        border-radius: 4px;
        color: #ffffff;
        font-size: 14px;
        cursor: pointer;
      }
      .main__selection {
        color: #ffffff;
        font-size: 14px;
      }

      /* ===== Table ===== */
      .table {
        width: 100%;
        border-collapse: collapse;
        background: var(--body-bg);
        border-radius: 4px;
        overflow: hidden;
      }
      .table__header {
        background: var(--darkened-bg);
        color: #ffffff;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 0.5px;
        width: 100%;
      }
      .table__header-cell {
        padding: 12px 16px;
        text-align: left;
      }
      .table__row {
        border-bottom: 1px solid #404040;
        transition: background 0.2s;
      }
      .table__row:hover {
        background: #404040;
      }
      tbody .table__row:nth-child(even) {
        background: var(--darkened-bg);
      }
      .table__cell {
        padding: 12px 16px;
        color: #ffffff;
        font-size: 14px;
      }
      .table__checkbox {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }
      .table__checkbox--select-all {
        margin: 0;
      }
      .table__uid {
        color: #4a90e2;
        font-family: monospace;
        font-size: 13px;
      }
      .table__email {
        color: #ffffff;
      }

      /* ===== Chat ===== */
      .chat {
        display: grid;
        grid-template-rows: 1fr;
        gap: 12px;
        width: 100%;
        max-height: 500px;
        overflow: auto;
        background: #1a1a1a;
        border: 1px solid var(--hairline-color);
        border-radius: 8px;
        padding: 12px;
      }
      .chat__messages {
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .chat__message {
        display: flex;
        width: 100%;
      }
      .chat__message--user {
        justify-content: flex-end;
      }
      .chat__message--assistant {
        justify-content: flex-start;
      }
      .chat__bubble {
        max-width: 70%;
        padding: 8px 12px;
        border-radius: 12px;
        line-height: 1.4;
        white-space: pre-wrap;
        word-break: break-word;
        font-size: 14px;
      }
      .chat__message--user .chat__bubble {
        background: #2d5a96;
        color: #ffffff;
        border-top-right-radius: 4px;
      }
      .chat__message--assistant .chat__bubble {
        background: #2a2a2a;
        color: #f0f0f0;
        border-top-left-radius: 4px;
      }

      /* ===== Pagination ===== */
      .pagination {
        display: flex;
        align-items: center;
        gap: 4px;
        margin-top: 16px;
      }
      .pagination__item {
        padding: 2px 6px;
        background: var(--darkened-bg);
        color: #ffffff;
        border: 1px solid var(--hairline-color);
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        text-decoration: none;
        transition: background 0.2s;
      }
      .pagination__item:hover {
        background: #404040;
      }
      .pagination__item--active {
        background: #4a90e2;
        color: #ffffff;
      }
      .pagination__item--disabled {
        background: var(--body-bg);
        color: #666;
        cursor: not-allowed;
      }
      .pagination__text {
        color: #ffffff;
        font-size: 14px;
        margin-left: 8px;
      }

      /* ===== Utilities ===== */
      .u-hidden {
        display: none;
      }
      .u-mb-8 {
        margin-bottom: 8px;
      }
      .u-mb-12 {
        margin-bottom: 12px;
      }
      .u-mb-16 {
        margin-bottom: 16px;
      }
      .u-mb-24 {
        margin-bottom: 24px;
      }
    </style>
  </head>
  <body class="page">
    <div class="header">
      <div class="header__title">Django administration</div>
    </div>

    <div class="breadcrumbs"></div>

    <div class="layout">
      <div class="layout__sidebar">
        <div class="sidebar__search">
          <input
            type="text"
            class="sidebar__input"
            placeholder="Start typing to filter..."
          />
        </div>
        <div class="js-left-list"></div>
      </div>

      <div class="layout__main">
        <h1 class="main__title">Select message to change</h1>

        <div class="main__search">
          <div class="main__search-group">
            <input
              type="text"
              id="search-messages-input"
              class="main__search-input main__search-input--messages"
              placeholder="search chats by messages"
            />
          </div>
          <div class="main__search-group">
            <input
              type="text"
              id="search-email-input"
              class="main__search-input main__search-input--email"
              placeholder="search chats by email"
            />
            <button id="search-btn" class="main__search-btn">Search</button>
          </div>
        </div>

        <nav
          class="main__filters"
          id="filters__date"
          aria-label="Фильтр по датам"
        ></nav>

        <div class="main__actions">
          <span class="main__action-label">Action:</span>
          <select class="main__action-select">
            <option>-------</option>
          </select>
          <button class="main__action-btn">Go</button>
          <span class="main__selection">0 of 51 selected</span>
        </div>

        <table class="table js-messages-table">
          <thead class="table__header">
            <tr>
              <th class="table__header-cell">
                <input
                  type="checkbox"
                  class="table__checkbox table__checkbox--select-all"
                />
              </th>
              <th class="table__header-cell">UID</th>
              <th class="table__header-cell">CHAT SESSION</th>
              <th class="table__header-cell">EMAIL</th>
            </tr>
          </thead>
          <tbody class="js-messages-list"></tbody>
        </table>
        <div class="js-pagination"></div>
      </div>
    </div>

    <script>
      const GET_FILTERS_URL = "/api/filters/"
      const GET_CHATS_URL = "/api/chats/"
      const GET_CHATS_MESSAGES_URL = "/api/chats/messages/"
      const GET_BREADCRUMBS_URL = "/api/breadcrumbs/"

      /**
       * EventEmitter - класс для работы с событиями
       * Позволяет подписываться на события, отписываться и вызывать их
       */
      class EventEmitter {
        constructor() {
          this.#events = {}
        }

        // Приватное поле для хранения событий и их обработчиков
        #events = {}

        /**
         * Подписаться на событие
         * @param {string} event - название события
         * @param {function} callback - функция-обработчик события
         */
        on(event, callback) {
          if (!this.#events[event]) {
            this.#events[event] = []
          }
          this.#events[event].push(callback)
        }

        /**
         * Отписаться от события
         * @param {string} event - название события
         * @param {function} [callback] - конкретный обработчик для удаления (если не указан, удаляются все)
         */
        off(event, callback) {
          if (!this.#events[event]) return

          if (!callback) {
            delete this.#events[event]
            return
          }

          this.#events[event] = this.#events[event].filter(
            (cb) => cb !== callback
          )
          if (this.#events[event].length === 0) {
            delete this.#events[event]
          }
        }

        /**
         * Вызвать событие и передать аргументы всем подписчикам
         * @param {string} event - название события
         * @param {...any} args - аргументы для передачи обработчикам
         */
        emit(event, ...args) {
          if (!this.#events[event]) return

          this.#events[event].forEach((callback) => {
            try {
              callback(...args)
            } catch (error) {
              console.error(`Error in event listener for "${event}":`, error)
            }
          })
        }

        /**
         * Подписаться на событие один раз (автоматически отписывается после первого вызова)
         * @param {string} event - название события
         * @param {function} callback - функция-обработчик события
         */
        once(event, callback) {
          const onceWrapper = (...args) => {
            callback(...args)
            this.off(event, onceWrapper)
          }
          this.on(event, onceWrapper)
        }

        /**
         * Получить количество подписчиков на событие
         * @param {string} event - название события
         * @returns {number} количество подписчиков
         */
        listenerCount(event) {
          return this.#events[event] ? this.#events[event].length : 0
        }

        /**
         * Получить список всех событий, на которые есть подписчики
         * @returns {string[]} массив названий событий
         */
        eventNames() {
          return Object.keys(this.#events)
        }

        /**
         * Удалить всех подписчиков события или всех подписчиков всех событий
         * @param {string} [event] - название события (если не указано, удаляются все события)
         */
        removeAllListeners(event) {
          if (event) {
            delete this.#events[event]
          } else {
            this.#events = {}
          }
        }
      }

      class PageRenderer {
        constructor() {
          this.root = document
          this.breadcrumbsContainer = this.root.querySelector(".breadcrumbs")
          this.leftContainer = this.root.querySelector(".js-left-list")
          this.centerContainer = this.root.querySelector(".js-messages-list")
          this.paginationContainer = this.root.querySelector(".js-pagination")
          this.selectAllCheckbox = this.root.querySelector(
            ".table__checkbox--select-all"
          )
          this.dateFilter = this.root.getElementById("filters__date")
          this.openChatRow = null
          this.currentChatMessages = null
          this.selectionElement = this.root.querySelector(".main__selection")
          this.totalItemsOnPage = 0
          // Обновим счётчик выбранных/всего при инициализации
          this.#updateSelectionText()
        }

        /**
         * Рендерит левую боковую панель (sidebar) с секциями и элементами меню
         * @param {Array} sections - массив объектов секций
         * Формат: [{ sectionTitle: string, list: [{ itemTitle: string, titleLink: string, addLink: string }] }]
         */
        renderLeftColumn(sections) {
          if (!this.leftContainer) return
          this.leftContainer.innerHTML = ""
          const safeSections = Array.isArray(sections) ? sections : []

          safeSections.forEach((section) => {
            // Create section title
            const sectionTitle = document.createElement("h3")
            sectionTitle.className = "sidebar__section-title"
            sectionTitle.textContent = this.#safeText(
              section && section.sectionTitle,
              "Section"
            )
            this.leftContainer.appendChild(sectionTitle)

            // Create section list
            const sectionList = document.createElement("ul")
            sectionList.className = "sidebar__list"

            const safeList = Array.isArray(section && section.list)
              ? section.list
              : []
            safeList.forEach((item) => {
              const listItem = document.createElement("li")
              listItem.className = "sidebar__item"

              const titleLink = document.createElement("a")
              titleLink.href = this.#safeText(item && item.titleLink, "#")
              titleLink.textContent = this.#safeText(
                item && item.itemTitle,
                "Item"
              )
              listItem.appendChild(titleLink)

              const addLink = document.createElement("a")
              addLink.href = this.#safeText(item && item.addLink, "#")
              addLink.className = "sidebar__add"
              addLink.textContent = "Add"
              listItem.appendChild(addLink)

              sectionList.appendChild(listItem)
            })

            this.leftContainer.appendChild(sectionList)
          })
        }

        /**
         * Рендерит основную таблицу с чатами, включая чекбоксы, UID, сессии и email
         * @param {Array} items - массив объектов чатов
         * Формат: [{ uid: string, email: string, session: string }]
         * Побочные эффекты: обновляет счетчик выбранных элементов, сбрасывает чекбокс "выбрать все"
         */
        renderChatsList(items) {
          if (!this.centerContainer) return
          this.centerContainer.innerHTML = ""
          const safeItems = Array.isArray(items) ? items : []
          this.totalItemsOnPage = safeItems.length

          safeItems.forEach((item) => {
            const row = document.createElement("tr")
            row.className = "table__row"

            // Checkbox cell
            const checkboxCell = document.createElement("td")
            checkboxCell.className = "table__cell"
            const checkbox = document.createElement("input")
            checkbox.type = "checkbox"
            checkbox.className = "table__checkbox table__checkbox--row"
            checkboxCell.appendChild(checkbox)
            row.appendChild(checkboxCell)

            // UID cell
            const uidCell = document.createElement("td")
            uidCell.className = "table__cell"
            const uidLink = document.createElement("button")
            uidLink.type = "button"
            uidLink.className = "table__uid"
            const uidValue = this.#safeText(
              item && item.uid,
              "c7d229bd-26c4-4757-9edb-cbe5f7765ca4"
            )
            uidLink.textContent = uidValue
            uidLink.dataset.chatid = uidValue
            // Обработчик клика теперь в глобальном document.addEventListener
            uidCell.appendChild(uidLink)
            row.appendChild(uidCell)

            // Chat session cell
            const sessionCell = document.createElement("td")
            sessionCell.className = "table__cell"
            const sessionText = document.createElement("span")
            sessionText.className = "table__email"
            sessionText.textContent =
              this.#safeText(item && item.email, "da000shi@gmail.com") +
              " - " +
              this.#safeText(item && item.session, "New chat")
            sessionCell.appendChild(sessionText)
            row.appendChild(sessionCell)

            // Email cell
            const emailCell = document.createElement("td")
            emailCell.className = "table__cell"
            const emailText = document.createElement("span")
            emailText.className = "table__email"
            emailText.textContent = this.#safeText(
              item && item.email,
              "da000shi@gmail.com"
            )
            emailCell.appendChild(emailText)
            row.appendChild(emailCell)

            this.centerContainer.appendChild(row)
          })

          // Add event listener for select all checkbox
          this.#setupSelectAll()
          // Add listeners for row checkboxes to update selection counter
          this.#setupRowCheckboxListeners()
          // Refresh selection text
          this.#updateSelectionText()
          // Снимем чекбокс "выбрать всё" при перерисовке
          if (this.selectAllCheckbox) this.selectAllCheckbox.checked = false
        }

        /**
         * Открывает чат для конкретного ID и отображает переданные сообщения
         * @param {string} chatId - ID чата (ищется по textContent кнопки UID)
         * @param {Array} messages - массив сообщений [{ role: 'user'|'assistant', content: string }]
         * Примечание: ищет чат по textContent, а не по data-chatid
         */
        chatMessageRender(chatId, messages) {
          if (!chatId) return
          const uids = Array.from(this.root.querySelectorAll(".table__uid"))
          const link = uids.find((el) => el.textContent === String(chatId))
          if (!link) return
          const row = link.closest("tr")
          if (!row) return
          this.#openChatForRow(row, undefined, messages)
        }

        /**
         * Сохраняет сообщения глобально для текущего чата
         * @param {Array} messages - массив сообщений [{ role: 'user'|'assistant', content: string }]
         * Побочные эффекты: сохраняет сообщения в this.currentChatMessages
         */
        setMessageContent(messages) {
          this.currentChatMessages = this.#normalizeMessages(messages)
        }

        /**
         * Находит чат по ID и открывает его с переданными сообщениями
         * @param {string} chatId - ID чата (ищется по data-chatid атрибуту)
         * @param {Array} messages - массив сообщений [{ role: 'user'|'assistant', content: string }]
         * Примечание: ищет чат по data-chatid атрибуту кнопки, если чат не найден - выводит предупреждение
         * Автоматически сохраняет сообщения и открывает чат
         */
        openChatById(chatId, messages) {
          // Ищем строку с нужным chatId
          const uidButtons = this.root.querySelectorAll(".table__uid")
          const targetButton = Array.from(uidButtons).find(
            (btn) => btn.dataset.chatid === chatId
          )

          if (!targetButton) {
            console.warn(`Chat with ID ${chatId} not found`)
            return
          }

          const row = targetButton.closest("tr")
          if (!row) return

          // Сохраняем сообщения
          this.currentChatMessages = this.#normalizeMessages(messages)

          // Открываем чат с переданными сообщениями
          this.#openChatForRow(row, null, this.currentChatMessages)
        }

        #openChatForRow(row, item, messages) {
          if (!row) return

          // Если под этой строкой уже вставлен чат — закрыть (toggle)
          const existingChatRow = row.nextElementSibling
          if (
            existingChatRow &&
            existingChatRow.classList.contains("js-chat-row")
          ) {
            this.#closeChatForRow(row)
            return
          }

          // Закрыть предыдущий открытый чат, если кликнули по другому UID
          if (this.openChatRow && this.openChatRow !== row) {
            this.#closeChatForRow(this.openChatRow)
          }

          // Создаем отдельную строку под текущей и вставляем окно чата, не удаляя колонки
          const columnCount = row.children.length
          const chatRow = document.createElement("tr")
          chatRow.className = "table__row js-chat-row"
          const chatCell = document.createElement("td")
          chatCell.className = "table__cell js-chat-cell"
          chatCell.setAttribute("colspan", String(columnCount))

          const chatWrapper = document.createElement("div")
          chatWrapper.className = "chat"

          const messagesContainer = document.createElement("div")
          messagesContainer.className = "chat__messages"

          // Определяем список сообщений: входные -> сохранённые глобально
          const stored = this.currentChatMessages
          const list = Array.isArray(messages)
            ? this.#normalizeMessages(messages)
            : Array.isArray(stored) && stored.length
            ? stored
            : []

          if (list.length === 0) {
            // Если сообщений нет, показываем заглушку
            const emptyMessage = document.createElement("div")
            emptyMessage.className = "chat__empty"
            emptyMessage.textContent = "Сообщений нет"
            emptyMessage.style.cssText = `
              text-align: center;
              color: #888;
              font-style: italic;
              padding: 20px;
            `
            messagesContainer.appendChild(emptyMessage)
          } else {
            list.forEach((msg) => {
              const role = msg && (msg.role === "user" ? "user" : "assistant")
              const content =
                typeof msg?.content === "string"
                  ? msg.content
                  : String(msg?.content ?? "")

              const msgRow = document.createElement("div")
              msgRow.className = `chat__message chat__message--${role}`

              const bubble = document.createElement("div")
              bubble.className = "chat__bubble"
              bubble.textContent = content

              msgRow.appendChild(bubble)
              messagesContainer.appendChild(msgRow)
            })
          }

          chatWrapper.appendChild(messagesContainer)
          chatCell.appendChild(chatWrapper)
          chatRow.appendChild(chatCell)
          row.parentNode.insertBefore(chatRow, row.nextSibling)

          this.openChatRow = row
        }

        #normalizeMessages(messages) {
          const src = Array.isArray(messages) ? messages : []
          return src.map((m) => ({
            role: m && m.role === "user" ? "user" : "assistant",
            content:
              typeof m?.content === "string"
                ? m.content
                : String(m?.content ?? ""),
          }))
        }

        #closeChatForRow(row) {
          if (!row) return
          const nextRow = row.nextElementSibling
          if (nextRow && nextRow.classList.contains("js-chat-row")) {
            nextRow.parentNode.removeChild(nextRow)
          }
          if (this.openChatRow === row) {
            this.openChatRow = null
          }
        }

        #setupSelectAll() {
          const selectAllCheckbox = this.root.querySelector(
            ".table__checkbox--select-all"
          )
          const rowCheckboxes = this.root.querySelectorAll(
            ".table__checkbox--row"
          )

          if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener("change", () => {
              const isChecked = selectAllCheckbox.checked
              rowCheckboxes.forEach((checkbox) => {
                checkbox.checked = isChecked
              })
              this.#updateSelectionText()
            })
          }
        }

        #setupRowCheckboxListeners() {
          const rowCheckboxes = this.root.querySelectorAll(
            ".table__checkbox--row"
          )
          rowCheckboxes.forEach((checkbox) => {
            checkbox.addEventListener("change", () => {
              this.#updateSelectionText()
            })
          })
        }

        #updateSelectionText() {
          const total = this.root.querySelectorAll(".table__row").length
          const selected = this.root.querySelectorAll(
            ".table__checkbox--row:checked"
          ).length
          if (this.selectionElement) {
            this.selectionElement.textContent = `selected ${selected} of ${total}`
          }
        }

        /**
         * Рендерит пагинацию внизу таблицы
         * @param {Object} params - объект с параметрами пагинации
         * @param {number} params.pagesAmount - общее количество страниц
         * @param {number} params.activePage - номер активной страницы
         */
        renderPagination({ pagesAmount, activePage }) {
          if (!this.paginationContainer) return
          this.paginationContainer.innerHTML = ""

          const pagination = document.createElement("div")
          pagination.className = "pagination"

          // Показываем первые страницы, активную и последние
          const pages = this.#generatePageNumbers(pagesAmount, activePage)

          pages.forEach((page) => {
            if (page === "...") {
              const dots = document.createElement("span")
              dots.className = "pagination__item pagination__item--disabled"
              dots.textContent = "..."
              pagination.appendChild(dots)
            } else {
              const pageItem = document.createElement("button")
              pageItem.className = `pagination__item${
                page === activePage ? " pagination__item--active" : ""
              }`
              pageItem.textContent = page
              pageItem.setAttribute("data-page", page)
              pagination.appendChild(pageItem)
            }
          })

          // Добавляем текст с общим количеством
          const totalText = document.createElement("span")
          totalText.className = "pagination__text"
          totalText.textContent = `${pagesAmount * 25} messages` // Предполагаем 25 сообщений на страницу
          pagination.appendChild(totalText)

          this.paginationContainer.appendChild(pagination)
        }

        /**
         * Рендерит хлебные крошки в .breadcrumbs
         * @param {Array} items - массив объектов [{ text: string, link: string }]
         */
        renderBreadcrumbs(items) {
          if (!this.breadcrumbsContainer) return
          this.breadcrumbsContainer.innerHTML = ""

          const safeItems = Array.isArray(items) ? items : []

          safeItems.forEach((item, index) => {
            const a = document.createElement("a")
            a.href =
              typeof item?.link === "string" && item.link ? item.link : "#"
            a.className = "breadcrumbs__link"
            a.textContent =
              typeof item?.text === "string" && item.text.trim().length
                ? item.text
                : ""
            this.breadcrumbsContainer.appendChild(a)

            if (index < safeItems.length - 1) {
              const sep = document.createElement("span")
              sep.textContent = " > "
              this.breadcrumbsContainer.appendChild(sep)
            }
          })
        }

        #generatePageNumbers(total, current) {
          const pages = []

          if (total <= 9) {
            // Если страниц мало, показываем все
            for (let i = 1; i <= total; i++) {
              pages.push(i)
            }
          } else {
            // Определяем начало окна из 5 страниц
            let startPage = 1

            // Если активная страница больше 3, сдвигаем окно
            if (current > 3) {
              startPage = Math.max(1, current - 2)
              // Но не дальше чем total - 4, чтобы всегда показать 5 страниц
              startPage = Math.min(startPage, total - 4)
            }

            // Показываем 5 страниц начиная с startPage
            for (let i = startPage; i < startPage + 5; i++) {
              pages.push(i)
            }

            // Добавляем троеточие только если есть разрыв
            if (startPage + 5 < total - 1) {
              pages.push("...")
            }

            // Показываем последние 2 страницы только если они не пересекаются с первыми 5
            if (startPage + 4 < total - 1) {
              for (let i = total - 1; i <= total; i++) {
                pages.push(i)
              }
            } else if (startPage + 4 < total) {
              // Если пересекается только с предпоследней, показываем только последнюю
              pages.push(total)
            }
          }

          return pages
        }

        #safeText(value, fallback) {
          return typeof value === "string" && value.trim().length
            ? value
            : fallback || ""
        }

        /**
         * Рендерит фильтры даты
         * @param {Array} items - массив объектов чатов
         * Формат: [{ uid: string, email: string, session: string }]
         * Побочные эффекты: обновляет счетчик выбранных элементов, сбрасывает чекбокс "выбрать все"
         */
        renderDateFilter(items) {}
      }

      const renderer = new PageRenderer()
      const dataEmitter = new EventEmitter()

      // Сохраняем текущие параметры поиска для пагинации
      let currentSearchParams = {}

      // Объявляем обработчики событий
      const ACTIONS = {
        loadedMainData: "mainData:loaded",
        loadedSidebarData: "sideBar:loaded",
        loadedBreadcrumbs: "breadcrumbs:loaded",
        renderPagination: "setPaginationData",
        setChatData: "setChatData",
        searchByMessage: "searchByMessage",
        searchByEmail: "searchByEmail",
        openChatAndInsertMessage: "openChagAndInsertMessage",
        renderDate: "render-date",
      }

      // ==== Регистрируем обработчик события ====
      dataEmitter.on(ACTIONS.loadedMainData, renderMainData)
      dataEmitter.on(ACTIONS.loadedSidebarData, renderSidebarData)
      dataEmitter.on(ACTIONS.loadedBreadcrumbs, renderBreadcrumbs)
      dataEmitter.on(ACTIONS.renderPagination, renderPagination)
      dataEmitter.on(ACTIONS.setChatData, setMessagesData)
      dataEmitter.on(ACTIONS.searchByMessage, searchChatsByMessage)
      dataEmitter.on(ACTIONS.searchByEmail, searchChatsByEmail)
      dataEmitter.on(ACTIONS.openChatAndInsertMessage, openChatAndInsertMessage)
      dataEmitter.on(ACTIONS.renderDate, renderDate)

      // ==== Функции рендера данных с сервера ====
      function renderMainData(data) {
        renderer.renderChatsList(data)
      }
      function renderSidebarData(data) {
        renderer.renderLeftColumn(data)
      }
      function renderBreadcrumbs(data) {
        renderer.renderBreadcrumbs(data)
      }
      function renderPagination(data) {
        renderer.renderPagination(data)
      }
      function setMessagesData(data) {
        renderer.setMessageContent(data)
      }

      function renderDate(date) {
        // логика по рендеру даты из PageRender
      }

      function searchChatsByMessage(searchQuery) {
        if (searchQuery && searchQuery.trim()) {
          currentSearchParams = {
            ...currentSearchParams,
            message: searchQuery.trim(),
          }
        } else {
          delete currentSearchParams.message
        }
        fetchMainData(1, currentSearchParams)
      }
      function searchChatsByEmail(searchQuery) {
        if (searchQuery && searchQuery.trim()) {
          currentSearchParams = {
            ...currentSearchParams,
            email: searchQuery.trim(),
          }
        } else {
          delete currentSearchParams.email
        }
        fetchMainData(1, currentSearchParams)
      }
      function openChatAndInsertMessage(data) {
        const { chatId, messages = [] } = data
        renderer.openChatById(chatId, messages)
      }

      // Запрашиваем данные с сервера и дёргаем емиттер
      async function fetchMainData(page = 1, searchParams = {}) {
        try {
          let url = GET_CHATS_URL + `?page=${page}`

          // Добавляем параметры поиска если они есть и не пустые
          if (searchParams.message && searchParams.message.trim()) {
            url += `&message=${encodeURIComponent(searchParams.message.trim())}`
          }
          if (searchParams.email && searchParams.email.trim()) {
            url += `&email=${encodeURIComponent(searchParams.email.trim())}`
          }
          // console.log({ url })
          const response = await fetch(url, {
            credentials: "include",
          })
          if (!response.ok) return
          const data = await response.json()

          // const mainPageData = {
          //   pagesAmount: 29,
          //   activePage: page,
          //   data: [
          //     {
          //       uid: "c7d229bd-26c4-4757-9edb-cbe5f7765ca4",
          //       email: "da000shi@gmail.com",
          //       session: "New chat",
          //     },
          //     {
          //       uid: "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
          //       email: "user@example.com",
          //       session: "Previous chat",
          //     },
          //     {
          //       uid: "f9e8d7c6-b5a4-3210-9876-543210fedcba",
          //       email: "admin@test.com",
          //       session: "Support chat",
          //     },
          //   ],
          // }

          // const data = await new Promise((resolve) => {
          //   setTimeout(() => {
          //     resolve(mainPageData)
          //   }, 1000)
          // })
          const { data: pageData, ...navigationData } = data

          // Эмитим событиями перерисовки страницы и обновлеем пагинацию
          dataEmitter.emit(ACTIONS.loadedMainData, pageData)
          dataEmitter.emit(ACTIONS.renderPagination, navigationData)
        } catch (error) {
          console.error("fetchMainData error:", error)
        }
      }

      // Запрос данных для sidebar
      async function fetchSidebarData(page) {
        try {
          const response = await fetch(GET_FILTERS_URL, {
            credentials: "include",
          })

          if (!response.ok) {
            console.error("ошибка получения сайдбара")
          }
          const data = await response.json()

          // const sidebarData = [
          //   {
          //     sectionTitle: "Authentication and Authorization",
          //     list: [
          //       { itemTitle: "Groups", titleLink: "#", addLink: "#" },
          //       {
          //         itemTitle: "Anonymous usage limits",
          //         titleLink: "#",
          //         addLink: "#",
          //       },
          //       { itemTitle: "Groups", titleLink: "#", addLink: "#" },
          //       {
          //         itemTitle: "Anonymous usage limits",
          //         titleLink: "#",
          //         addLink: "#",
          //       },
          //       { itemTitle: "Groups", titleLink: "#", addLink: "#" },
          //       {
          //         itemTitle: "Anonymous usage limits",
          //         titleLink: "#",
          //         addLink: "#",
          //       },
          //       { itemTitle: "Groups", titleLink: "#", addLink: "#" },
          //     ],
          //   },
          //   {
          //     sectionTitle: "LLM Integration",
          //     list: [{ itemTitle: "Messages", titleLink: "#", addLink: "#" }],
          //   },
          //   {
          //     sectionTitle: "Payments",
          //     list: [
          //       { itemTitle: "Billing plans", titleLink: "#", addLink: "#" },
          //     ],
          //   },
          //   {
          //     sectionTitle: "Python Social Auth",
          //     list: [{ itemTitle: "Users", titleLink: "#", addLink: "#" }],
          //   },
          // ]

          // const data = await new Promise((resolve) => {
          //   setTimeout(() => {
          //     resolve(sidebarData)
          //   }, 1000)
          // })
          dataEmitter.emit(ACTIONS.loadedSidebarData, data)
        } catch (error) {
          console.error("fetchSidebarData error:", error)
        }
      }

      // Запрос хлебных крошек
      async function fetchBreadcrumbs() {
        try {
          const response = await fetch(GET_BREADCRUMBS_URL, {
            credentials: "include",
          })
          if (!response.ok) {
            throw new Error("Ошибка получения breadcrumbs")
          }
          const data = await response.json()
          dataEmitter.emit(ACTIONS.loadedBreadcrumbs, data)
        } catch (error) {
          console.error(error)
        }
      }

      // Запрос сообщений для чата
      async function fetchChatMessages(chatId) {
        try {
          const response = await fetch(
            GET_CHATS_MESSAGES_URL + `?chatId=${chatId}`,
            {
              credentials: "include",
            }
          )

          if (!response.ok) {
            console.error("ошибка получения сообщения")
          }
          const data = await response.json()
          return data
        } catch (error) {
          console.error("fetchChatMessages error:", error)
        }
      }

      // ВЕШАЕМ ОБРАБОТЧИКИ СОБЫТИЙ
      document.addEventListener("click", (e) => {
        // Обработка нажатия на элемент пагинации
        if (e.target.classList.contains("pagination__item")) {
          const pageNumber = e.target.dataset.page
          fetchMainData(Number(pageNumber), currentSearchParams)
          return
        }

        // Вызываем подгрузку сообщений для чата
        if (e.target.classList.contains("table__uid")) {
          const chatId = e.target.dataset.chatid

          // const data = [
          //   { role: "user", content: "Здравствуйте!" },
          //   { role: "assistant", content: "Добрый день!" },
          //   { role: "user", content: "Иди нахуй" },
          // ]

          fetchChatMessages(chatId).then((data) => {
            dataEmitter.emit(ACTIONS.openChatAndInsertMessage, {
              chatId,
              messages: data,
            })
          })
        }

        // Обработка поиска одним кликом: собираем оба поля
        if (e.target.classList.contains("main__search-btn")) {
          const messageInput = document.getElementById("search-messages-input")
          const emailInput = document.getElementById("search-email-input")
          const messageValue = (messageInput?.value || "").trim()
          const emailValue = (emailInput?.value || "").trim()

          if (messageValue) {
            currentSearchParams = {
              ...currentSearchParams,
              message: messageValue,
            }
          } else {
            delete currentSearchParams.message
          }

          if (emailValue) {
            currentSearchParams = {
              ...currentSearchParams,
              email: emailValue,
            }
          } else {
            delete currentSearchParams.email
          }

          fetchMainData(1, currentSearchParams)
        }
      })

      /* Данные dateFilter */
      // ==== Примеры разнородных данных (просто для демонстрации) ====
      // ==== Пример моков: произвольный список с ISO-датами (может быть Date/ts) ====
      const items = [
        { id: 1, date: "2024-12-29", title: "Legacy" },
        { id: 2, created_at: "2025-05-07", title: "A" },
        { id: 3, created_at: "2025-05-08T10:30:00Z", title: "B" },
        { id: 4, happenedAt: 1751913600000, title: "C" }, // 2025-07-08 timestamp (UTC ms)
        { id: 5, when: new Date("2025-06-02"), title: "D" },
        { id: 6, date: "2025-06-03" },
        { id: 7, date: "2025-06-04" },
        { id: 8, date: "2025-06-05" },
        { id: 9, date: "2025-06-06" },
        { id: 10, date: "2025-06-09" },
        { id: 11, date: "2025-06-16" },
        { id: 12, date: "2025-06-18" },
        { id: 13, date: "2025-06-19" },
        { id: 14, date: "2025-06-29" },
        { id: 15, date: "2025-06-30" },
        { id: 16, date: "2025-07-04" },
        { id: 17, date: "2025-07-05" },
        { id: 18, date: "2025-07-06" },
        { id: 19, date: "2025-07-07" },
        { id: 20, date: "2025-07-08" },
        { id: 21, date: "2025-08-22" },
        { id: 22, date: "2025-08-28" },
        { id: 23, date: "2025-08-30" },
        { id: 24, date: "2025-09-02" },
        { id: 25, date: "2025-09-04" },
        { id: 26, date: "2025-09-10" },
        { id: 27, date: "2025-09-11" },
      ]

      //====
      class DateFilterRender {
        static MONTHS_EN = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ]
        static pad(n) {
          return String(n).padStart(2, "0")
        }
        static monthToNumberByName(name) {
          const i = DateFilterRender.MONTHS_EN.indexOf(name)
          return DateFilterRender.pad(i >= 0 ? i + 1 : 0)
        }
        static escapeHtml(s) {
          return String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;")
        }
        // Парсим "источник даты" в части (год/месяц/день) без TZ-сюрпризов
        static parseToParts(input) {
          let d
          if (input instanceof Date) d = input
          else if (typeof input === "number") d = new Date(input)
          else if (typeof input === "string") {
            const m = input.match(/^(\d{4})-(\d{2})-(\d{2})(?:$|T)/)
            if (m) {
              const y = +m[1],
                mo = +m[2],
                da = +m[3]
              const monthName = DateFilterRender.MONTHS_EN[mo - 1] || "Unknown"
              return {
                year: y,
                monthIndex: mo - 1,
                monthName,
                monthLabel: `${monthName} ${y}`,
                day: da,
              }
            }
            d = new Date(input) // ISO с временем
          } else throw new Error("Unsupported date input")

          if (Number.isNaN(d.getTime())) throw new Error("Invalid date")
          const y = d.getUTCFullYear()
          const mo = d.getUTCMonth()
          const da = d.getUTCDate()
          const monthName = DateFilterRender.MONTHS_EN[mo] || "Unknown"
          return {
            year: y,
            monthIndex: mo,
            monthName,
            monthLabel: `${monthName} ${y}`,
            day: da,
          }
        }
        // Строим индекс: year → monthLabel → day → [items]
        static buildIndex(list, getDate) {
          const idx = {}
          for (const it of list) {
            const raw = getDate(it)
            if (raw == null) continue
            let p
            try {
              p = DateFilterRender.parseToParts(raw)
            } catch {
              continue
            }
            const { year, monthLabel, day } = p
            idx[year] ??= {}
            idx[year][monthLabel] ??= {}
            idx[year][monthLabel][day] ??= []
            idx[year][monthLabel][day].push(it)
          }
          // сортируем дни
          for (const y of Object.keys(idx)) {
            for (const m of Object.keys(idx[y])) {
              const days = Object.keys(idx[y][m])
                .map(Number)
                .sort((a, b) => a - b)
              const ordered = {}
              for (const d of days) ordered[d] = idx[y][m][d]
              idx[y][m] = ordered
            }
          }
          return idx
        }

        /**
         * @param {HTMLElement} container — узел, куда рисуем (например, #filters__date)
         * @param {Array<any>} list — произвольный список записей
         * @param {{ getDate?:(it:any)=>string|number|Date, yearOrder?:"asc"|"desc" }} [opts]
         */
        constructor(container, list, opts = {}) {
          this.container = container
          this.getDate = opts.getDate || this.#autoDetectGetDate(list)
          this.yearOrder = opts.yearOrder || "desc"
          this.state = { level: "root", year: null, month: null, day: null }
          this.index = DateFilterRender.buildIndex(list, this.getDate)
          this.updateView() // первая отрисовка
        }

        // Публичные методы
        setData(list) {
          this.index = DateFilterRender.buildIndex(list, this.getDate)
          this.goRoot()
        }
        setDateExtractor(fn) {
          this.getDate = fn
          // перестраиваем индекс на основе текущих исходных данных недоступно — нужен список.
          // В реальном месте вызова вызови setData(list) сразу после смены extractor.
        }
        goRoot() {
          this.state = { level: "root", year: null, month: null, day: null }
          this.updateView()
        }
        goYear(year) {
          this.state = { level: "year", year, month: null, day: null }
          this.updateView()
        }
        goMonth(year, month) {
          this.state = { level: "month", year, month, day: null }
          this.updateView()
        }
        goDate(year, month, day) {
          this.state = { level: "date", year, month, day }
          this.updateView()
        }
        navigateBack(e) {
          e?.preventDefault?.()
          const { level } = this.state
          if (level === "root") return
          if (level === "year") this.goRoot()
          else if (level === "month") this.goYear(this.state.year)
          else if (level === "date")
            this.goMonth(this.state.year, this.state.month)
        }

        // ===== Ниже — внутренняя отрисовка DOM =====
        updateView() {
          const c = this.container
          c.innerHTML = ""

          // Крошка «назад»
          const crumb = document.createElement("a")
          crumb.href = "#"
          crumb.className = "main__filter"
          crumb.addEventListener("click", (e) => this.navigateBack(e))
          const st = this.state
          if (st.level === "root")
            crumb.innerHTML = `<span class="arrow">&lt;</span>All dates`
          else if (st.level === "year")
            crumb.innerHTML = `<span class="arrow">&lt;</span>Years`
          else if (st.level === "month")
            crumb.innerHTML = `<span class="arrow">&lt;</span>${DateFilterRender.escapeHtml(
              String(st.year)
            )}`
          else
            crumb.innerHTML = `<span class="arrow">&lt;</span>${DateFilterRender.escapeHtml(
              st.month
            )}`
          crumb.classList.add("main__filter--active")
          c.appendChild(crumb)

          // Тело
          if (st.level === "root") {
            const years = Object.keys(this.index)
              .map(Number)
              .sort((a, b) => (this.yearOrder === "desc" ? b - a : a - b))
            if (years.length === 0) {
              c.appendChild(this.#muted("Нет данных"))
              return
            }
            years.forEach((y) => {
              c.appendChild(this.#link(String(y), () => this.goYear(y)))
            })
          } else if (st.level === "year") {
            const months = Object.keys(this.index[st.year] || {})
            if (months.length === 0) {
              c.appendChild(this.#muted("Нет месяцев"))
              return
            }
            months.forEach((m) => {
              const daysObj = this.index[st.year][m] || {}
              const count = Object.values(daysObj).reduce(
                (acc, arr) => acc + arr.length,
                0
              )
              const a = this.#link(`${m}${count ? ` (${count})` : ``}`, () =>
                this.goMonth(st.year, m)
              )
              if (!count) a.setAttribute("aria-disabled", "true")
              c.appendChild(a)
            })
          } else if (st.level === "month") {
            const daysObj =
              (this.index[st.year] && this.index[st.year][st.month]) || {}
            const days = Object.keys(daysObj).map(Number)
            if (!days.length) {
              c.appendChild(this.#muted("Нет дат"))
              return
            }
            const monthWord = st.month.split(" ")[0]
            days.forEach((d) => {
              const count = daysObj[d].length
              c.appendChild(
                this.#link(
                  `${monthWord} ${d}${count > 1 ? ` (${count})` : ``}`,
                  () => {
                    this.goDate(st.year, st.month, d)
                    const url = `/${st.year}/${DateFilterRender.monthToNumberByName(
                      monthWord
                    )}/${DateFilterRender.pad(d)}`
                    console.log("Navigate to", url)
                  }
                )
              )
            })
          } else if (st.level === "date") {
            const monthWord = st.month.split(" ")[0]
            c.appendChild(
              this.#link(`${monthWord} ${st.day}`, () => {
                const url = `/${st.year}/${DateFilterRender.monthToNumberByName(
                  monthWord
                )}/${DateFilterRender.pad(st.day)}`
                console.log("Navigate to", url)
                // window.location.href = url;
              })
            )
          }
        }

        // ===== Внутренние помощники =====
        #link(text, onClick) {
          const a = document.createElement("a")
          a.href = "#"
          a.className = "main__filter"
          a.textContent = text
          a.addEventListener("click", (e) => {
            e.preventDefault()
            onClick?.()
          })
          return a
        }
        #muted(text) {
          const span = document.createElement("span")
          span.className = "main__filter"
          span.style.opacity = "0.6"
          span.textContent = text
          return span
        }
        #autoDetectGetDate(list) {
          const candidates = [
            "date",
            "created_at",
            "createdAt",
            "updated_at",
            "updatedAt",
            "happenedAt",
            "when",
            "timestamp",
          ]
          const sample = list.find(Boolean) || {}
          const key = candidates.find((k) => k in sample) || "date"
          return (item) => item?.[key]
        }
      }

      // ==== Инициализация ====
      function initDateFilters() {
        const el = document.getElementById("filters__date")
        // Явно: new DateFilterRender(el, items, { getDate: it => it.created_at });
        new DateFilterRender(el, items)
      }

      // Инициализируем данные при загрузке страницы
      function init() {
        initDateFilters()
        fetchMainData()
        fetchSidebarData()
        fetchBreadcrumbs()
      }

      // Инициализируем данные
      init()
    </script>
  </body>
</html>
